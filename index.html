<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×™××•×“ ×§×¨×™××” ×‘×ª×•×¨×”</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'SBL Hebrew', 'Ezra SIL', sans-serif; background: #fdfbf7; color: #333; margin: 0; padding-bottom: 100px; }
        header { background: #2c3e50; padding: 15px; text-align: center; color: white; position: sticky; top: 0; z-index: 90; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        select { 
            font-size: 18px; padding: 8px 20px; border-radius: 25px; border: none; 
            font-weight: bold; color: #2c3e50; background: #fff; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); outline: none;
        }

        .pasuk { display: flex; align-items: flex-start; gap: 10px; font-size: 22px; padding: 15px 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .pasuk:hover { background: #f8f9fa; }
        .pasuk.playing { background: #e8f4fc; border-right: 4px solid #3498db; }
        .pasuk-content { flex-grow: 1; line-height: 1.6; }
        .num { color: #c0392b; font-weight: bold; font-size: 0.8em; margin-left: 5px; }
        
        /* ×›×¤×ª×•×¨ ×”××•× ×” */
        .counter-btn { 
            background: #fff; border: 2px solid #f1c40f; border-radius: 12px; 
            padding: 5px 8px; min-width: 45px; text-align: center; 
            font-size: 14px; font-weight: bold; color: #f39c12; 
            margin-top: 5px; z-index: 2; user-select: none; 
        }
        .counter-btn:active { transform: scale(0.9); }
        
        .controls { position: fixed; bottom: 0; left: 0; right: 0; background: white; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); padding: 12px; display: flex; justify-content: center; gap: 15px; z-index: 100; }
        .btn { padding: 12px 20px; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .btn-play { background: #2ecc71; } .btn-stop { background: #e74c3c; } .btn-reset { background: #95a5a6; }
        
        /* ×—×œ×•× ×™×ª ×¤×¨×¡ */
        #reward-toast { 
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(255, 255, 255, 0.98); padding: 25px; border-radius: 25px; 
            border: 4px solid #f1c40f; text-align: center; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3); display: none; z-index: 1000;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 200px;
        }
        
        #reward-toast img {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            border: 3px solid #f1c40f; margin-bottom: 10px; display: none;
        }

        #reward-text { display: block; font-size: 1.8rem; font-weight: bold; color: #e67e22; }

        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }
    </style>
</head>
<body>
    <header>
        <select id="chapterSelect" onchange="loadChapterFromFile(this.value)"></select>
    </header>

    <div id="reward-toast">
        <img id="reward-img" src="me.jpg" alt="Teacher">
        <span id="reward-text">×›×œ ×”×›×‘×•×“!</span>
    </div>

    <div id="content" style="margin-top: 20px;"></div>

    <div class="controls">
        <button class="btn btn-play" onclick="playAll()">â–¶ × ×’×Ÿ</button>
        <button class="btn btn-stop" onclick="stopAudio()">â¹ ×¢×¦×•×¨</button>
        <button class="btn btn-reset" onclick="resetCounts()">â†º</button>
    </div>

    <script>
        const START_CHAPTER = 1;
        const END_CHAPTER = 50;

        let currentChapter = null;
        let verseIds = [];
        let currentAudio = null;
        let isAutoPlaying = false;
        
        // ×§×‘×¦×™ ××•×“×™×• ×œ×—×™×–×•×§
        const audioGood = new Audio('good.m4a');
        const audioChamp = new Audio('champion.m4a');

        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('chapterSelect');
            for (let i = START_CHAPTER; i <= END_CHAPTER; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = `×¤×¨×§ ${toHebrewNum(i)} (${i})`;
                select.appendChild(option);
            }
            const lastViewed = localStorage.getItem('lastChapter') || "10";
            select.value = lastViewed;
            loadChapterFromFile(lastViewed);
        });

        function toHebrewNum(num) {
            const tens = ['','×™','×›','×œ','×','× ','×¡','×¢','×¤','×¦'];
            const units = ['','×','×‘','×’','×“','×”','×•','×–','×—','×˜'];
            if (num === 15) return "×˜×•"; if (num === 16) return "×˜×–";
            const ten = Math.floor(num / 10); const unit = num % 10;
            let res = ""; if (ten > 0) res += tens[ten]; if (unit > 0) res += units[unit];
            if (num >= 1 && num <= 9) return res + "'"; 
            return res.replace(/×™×”/, '×˜×•').replace(/×™×•/, '×˜×–');
        }

        async function loadChapterFromFile(chapNum) {
            stopAudio();
            currentChapter = chapNum;
            verseIds = [];
            localStorage.setItem('lastChapter', chapNum);
            const container = document.getElementById('content');
            container.innerHTML = '<p style="text-align:center; margin-top:50px; color:#7f8c8d;">×˜×•×¢×Ÿ ××ª ×”×˜×§×¡×˜...</p>';

            try {
                const response = await fetch(`${chapNum}.txt?t=${Date.now()}`);
                if (!response.ok) throw new Error("missing");
                const text = await response.text();
                parseAndBuild(text, chapNum);
            } catch (error) {
                container.innerHTML = `<div style="text-align:center; padding:30px;">
                    <h3>×—×¡×¨ ×§×•×‘×¥ ×˜×§×¡×˜ ×œ×¤×¨×§ ${chapNum}</h3>
                    <p>× × ×œ×™×¦×•×¨ ×§×•×‘×¥ <b>${chapNum}.txt</b></p>
                </div>`;
            }
        }

        function parseAndBuild(rawText, chapNum) {
            const container = document.getElementById('content');
            container.innerHTML = '';
            let cleanText = rawText.replace(/\{[×¡×¤]\}/g, ' ').replace(/\s+/g, ' ').trim();
            cleanText = cleanText.replace(/(^|\s)([×-×ª]{1,3})(?=\s)/g, "$1###$2");
            const parts = cleanText.split('###');
            
            parts.forEach(part => {
                part = part.trim();
                if(!part) return;
                const firstSpace = part.indexOf(' ');
                if(firstSpace === -1) return;
                
                const letterNum = part.substring(0, firstSpace);
                const textContent = part.substring(firstSpace + 1);
                const realNum = gematriaToNum(letterNum);

                if(realNum > 0) {
                    verseIds.push(realNum);
                    const saved = localStorage.getItem(`ch${chapNum}_v${realNum}`) || 0;
                    
                    const div = document.createElement('div');
                    div.className = 'pasuk';
                    div.id = `p${realNum}`;
                    div.onclick = () => playSingle(realNum);
                    div.innerHTML = `
                        <div class="counter-btn" onclick="increment(${realNum}, event)">
                            <span id="cnt${realNum}">${saved}</span>
                            <span class="counter-label">×—×–×¨×•×ª</span>
                        </div>
                        <div class="pasuk-content"><span class="num">${letterNum}</span> ${textContent}</div>
                    `;
                    container.appendChild(div);
                    new Audio(`${chapNum}_${realNum}.m4a`).preload = 'auto';
                }
            });
        }

        function gematriaToNum(str) {
            const map = {'×':1, '×‘':2, '×’':3, '×“':4, '×”':5, '×•':6, '×–':7, '×—':8, '×˜':9, '×™':10, '×›':20, '×œ':30, '×':40, '× ':50, '×¡':60, '×¢':70, '×¤':80, '×¦':90, '×§':100, '×¨':200, '×©':300, '×ª':400};
            let sum = 0;
            for (let char of str) if (map[char]) sum += map[char];
            if (str.includes('×˜') && str.includes('×•')) return 15;
            if (str.includes('×˜') && str.includes('×–')) return 16;
            return sum;
        }

        // --- ×”×œ×•×’×™×§×” ×”×—×“×©×” ×œ×¡×¤×™×¨×” ---
        function increment(id, e) {
            e.stopPropagation(); // ××•× ×¢ ××ª ×”×œ×—×™×¦×” ×”×¨×’×™×œ×” ×¢×œ ×”×©×•×¨×”
            const el = document.getElementById(`cnt${id}`);
            let val = parseInt(el.innerText);
            
            // ×ª× ××™ ×§×¨×™×˜×™: ×× ×¤×—×•×ª ×-5, ×—×•×‘×” ×œ× ×’×Ÿ ××ª ×”××•×“×™×•
            if (val < 5) {
                playSingle(id); 
            }
            // ×× 5 ×•××¢×œ×” - ×¨×§ ××¢×œ×™× ××¡×¤×¨ (××¦×‘ ×©×§×˜)

            val++;
            el.innerText = val;
            localStorage.setItem(`ch${currentChapter}_v${id}`, val);
            
            // ×‘×“×™×§×ª ×¤×¨×¡×™×
            if(val % 10 === 0) triggerReward("BIG"); 
            else if(val % 5 === 0) triggerReward("SMALL");
        }

        function triggerReward(type) {
            const toast = document.getElementById('reward-toast');
            const textEl = document.getElementById('reward-text');
            const imgEl = document.getElementById('reward-img');

            if(currentAudio) currentAudio.pause(); // ×¢×•×¦×¨ ××ª ×¤×¡×•×§ ×”×œ×™××•×“ ×›×“×™ ×œ×©××•×¢ ××ª ×”×—×™×–×•×§

            if (type === "BIG") {
                textEl.innerText = "ğŸ‘‘ ××™×–×” ××œ×•×£!! ğŸ‘‘";
                imgEl.style.display = "inline-block"; 
                audioChamp.play().catch(e => console.log("No audio file found"));
                confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 } });
            } else { 
                textEl.innerText = "â­ ×›×œ ×”×›×‘×•×“! â­";
                imgEl.style.display = "none"; 
                audioGood.play().catch(e => console.log("No audio file found"));
                confetti({ particleCount: 60, spread: 60, origin: { y: 0.7 } });
            }

            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2500);
        }

        let currentIdx = 0;
        function playSingle(id, auto=false) {
            if(currentAudio) currentAudio.pause();
            document.querySelectorAll('.pasuk').forEach(p=>p.classList.remove('playing'));
            isAutoPlaying = auto;
            currentIdx = verseIds.indexOf(id);
            const div = document.getElementById('p'+id);
            if(div) { div.classList.add('playing'); if(auto) div.scrollIntoView({behavior:"smooth", block:"center"}); }
            
            currentAudio = new Audio(`${currentChapter}_${id}.m4a`);
            currentAudio.play().catch(()=>{ if(isAutoPlaying) playNext(); });
            currentAudio.onended = () => { if(div) div.classList.remove('playing'); if(isAutoPlaying) playNext(); };
        }

        function playNext() {
            if(currentIdx < verseIds.length - 1) playSingle(verseIds[currentIdx+1], true);
            else isAutoPlaying = false;
        }

        function playAll() { if(verseIds.length) playSingle(verseIds[0], true); }
        function stopAudio() { if(currentAudio) currentAudio.pause(); isAutoPlaying=false; document.querySelectorAll('.pasuk').forEach(p=>p.classList.remove('playing')); }
        function resetCounts() { if(confirm('×œ××¤×¡ ××ª ×”×¡×¤×™×¨×”?')) verseIds.forEach(id=>{ localStorage.removeItem(`ch${currentChapter}_v${id}`); document.getElementById(`cnt${id}`).innerText='0'; }); }
    </script>
</body>
</html>
